# Markdown Kanban - 要件定義書

## 概要

Markdownファイル内のTODOリスト（チェックボックス）をカンバンボード形式で表示・操作できるVSCode拡張機能。

### なぜ作るのか

Markdownによるタスク管理には多くのメリットがある：

- テキストベースでシンプル、どこでも読み書きできる
- Gitでバージョン管理しやすい
- 特定のツールにロックインされない
- ドキュメントとタスクを同じ場所で管理できる

一方で、視認性や操作性には限界がある。

**→ Markdownの良さを活かしつつ、リッチなUIで管理したい**

### 基本コンセプト

- Markdown標準の記法を尊重し、素のMarkdownとしても可読性を維持
- 見出し階層を「パス」として解釈し、タスクのグルーピングに使用
- ステータスはタスクの子要素（`key: value`形式）で管理
- 設定は「フロントマター → VSCode設定 → デフォルト」の優先順位で解決

---

## 対象ファイル

### MVPスコープ

- 単一のMarkdownファイルのみ
- Markdownファイルを開いている時、エディタ右上のアクションボタンからボードビューを起動

### 将来の拡張

- 複数ファイルの横断表示（パスの上位概念としてファイルを扱う）

---

## Markdownの構造解釈

### タスクの認識

チェックボックス形式のリストアイテムをタスクとして認識する。

```markdown
- [ ] 未完了タスク
- [x] 完了タスク
```

### パス（グルーピング）

見出しの階層構造をパスとして解釈する。タスクが属する見出しの階層がそのままパスになる。

```markdown
# 仕事                      ← パス: 仕事
## プロジェクトA             ← パス: 仕事 / プロジェクトA
- [ ] APIの実装             ← このタスクのパス: 仕事 / プロジェクトA

## プロジェクトB             ← パス: 仕事 / プロジェクトB  
- [ ] 要件定義              ← このタスクのパス: 仕事 / プロジェクトB

# 個人                      ← パス: 個人
- [ ] 部屋の掃除            ← このタスクのパス: 個人
```

見出しの深さに制限はなく、任意の階層を扱える。

### メタデータ（子要素）

タスクの子要素として `key: value` 形式でメタデータを記述できる。

```markdown
- [ ] APIの実装
  - status: in-progress
  - priority: high
  - due: 2025-01-15
```

---

## ステータス管理

### ステータスの決定ロジック

以下の優先順位でステータスを決定する：

1. 子要素に `status` があれば → その値を使用
2. なければ → チェックボックスの状態と設定で判定
   - `[x]` → `defaultDoneStatus`（デフォルト: `done`）
   - `[ ]` → `defaultStatus`（デフォルト: `todo`）

### 完了判定

設定で「完了扱いとするステータス」を定義する。それ以外は全て未完了として扱う。

### ステータス変更時の挙動

ボード上でステータスを変更した場合：

1. 子要素の `status` を更新（なければ追加）
2. 完了ステータスに変更した場合 → チェックボックスを `[x]` に
3. 未完了ステータスに変更した場合 → チェックボックスを `[ ]` に

---

## 設定

### 優先順位

```
1. フロントマター（ファイル固有）
   ↓ なければ
2. VSCode設定（ワークスペース or ユーザー）
   ↓ なければ
3. ビルトインデフォルト
```

### フロントマター

```yaml
---
kanban:
  statuses:
    - todo
    - in-progress
    - done
  doneStatuses:
    - done
  defaultStatus: todo
  defaultDoneStatus: done
---
```

### VSCode設定

```jsonc
// .vscode/settings.json
{
  // ステータス一覧（カラムの表示順）
  "markdownKanban.statuses": ["todo", "in-progress", "done"],
  
  // 完了扱いとするステータス
  "markdownKanban.doneStatuses": ["done"],
  
  // デフォルトステータス（[ ] の時、status未指定時に使用）
  "markdownKanban.defaultStatus": "todo",
  
  // デフォルト完了ステータス（[x] の時、status未指定時に使用）
  "markdownKanban.defaultDoneStatus": "done",
  
  // ソート順
  "markdownKanban.sortBy": "markdown",  // "markdown" | "priority" | "due" | "alphabetical"
  
  // Done時にチェックボックスも連動させるか
  "markdownKanban.syncCheckboxWithDone": true,
  
  // 新規タスク追加時の挿入位置（将来）
  "markdownKanban.newTaskPosition": "endOfFile"  // or "afterHeading:## タスクリスト"
}
```

### ビルトインデフォルト

| 項目 | デフォルト値 |
|------|-------------|
| statuses | `["todo", "in-progress", "done"]` |
| doneStatuses | `["done"]` |
| defaultStatus | `"todo"` |
| defaultDoneStatus | `"done"` |
| sortBy | `"markdown"` |
| syncCheckboxWithDone | `true` |

---

## ボードUI

### 表示形式

- WebViewパネルとして表示
- Markdownエディタ右上のアクションボタンから起動

### レイアウト

```
┌─────────────────────────────────────────────────┐
│ [ファイル名.md]                                  │
├───────────┬─────────────┬───────────────────────┤
│ todo      │ in-progress │ done                  │
├───────────┼─────────────┼───────────────────────┤
│ ┌───────┐ │ ┌─────────┐ │                       │
│ │タスクA │ │ │タスクD  │ │                       │
│ │[パス] │ │ │[パス]   │ │                       │
│ └───────┘ │ └─────────┘ │                       │
│ ┌───────┐ │             │                       │
│ │タスクB │ │             │                       │
│ │[パス] │ │             │                       │
│ └───────┘ │             │                       │
│           │             │                       │
│ [+]       │ [+]         │ [+]                   │
└───────────┴─────────────┴───────────────────────┘
```

### タスクカード

- タスク名をMarkdown形式でレンダリング（長い場合は折り返し）
- パスをバッジで表示
- クリックで編集モーダルを開く

### 並び順

- 手動D&Dによる並び替えは非対応（MVP）
- 設定の `sortBy` に従って自動ソート
  - `markdown`: ファイル内の出現順
  - `priority`: 優先度順
  - `due`: 期限順
  - `alphabetical`: アルファベット順

---

## タスク操作

### モーダル入力項目（MVP）

| 項目 | 入力形式 | 備考 |
|------|---------|------|
| タスク名 | テキスト | 必須 |
| ステータス | ドロップダウン | statuses設定から選択 |
| パス | ドロップダウン | 既存の見出しから選択（新規作成は不可） |

パスの選択肢は、ファイル内の見出し階層から自動生成する：

```
例：
- （ルート）
- 仕事
- 仕事 / プロジェクトA
- 仕事 / プロジェクトB
- 個人
```

### 新規作成

- 各カラム下部の「+」ボタンから作成
- モーダルが開く（全フィールドがデフォルト値、削除ボタンなし）
- 追加位置：選択したパス（見出し）配下の末尾

### 編集

- タスクカードをクリックでモーダルを開く
- 既存の値が入力済み
- 削除ボタンあり

### 削除

- 編集モーダル内の削除ボタンから実行

### ドラッグ&ドロップ

| 操作 | MVP対応 | 挙動 |
|------|--------|------|
| 列間移動（ステータス変更） | ✓ | 子要素のstatusを書き換え |
| 同一列内の並び替え | ✗ | 非対応 |

---

## 保存フロー

### 編集の反映

```
ボード操作（モーダル更新 or D&D）
          ↓
VSCodeの編集API（WorkspaceEdit）でドキュメントを変更
          ↓
エディタ上は「未保存」状態（●マークがつく）
Markdownエディタ側にも変更が即時反映される
          ↓
   保存 → document.save() or Ctrl+S
   破棄 → revert
```

### 特徴

- Markdownエディタとボードが常に同期
- VSCode標準のUndo/Redoが有効
- VSCode標準の保存操作（Ctrl+S）が使える

---

## パースルール

### タスクとして認識しないもの

以下の構造内のチェックボックスはタスクとして認識しない：

```markdown
> - [ ] 引用内のチェックボックス → 無視

```
- [ ] コードブロック内 → 無視
```
```

### 子要素の解釈

各子要素の行に対して：

1. `key: value` の形式にマッチするか判定
2. マッチすれば → メタデータとして採用
3. マッチしなければ → 無視（エラーにしない）

```markdown
- [ ] タスク
  - status: todo        ← ✓ 認識
  - priority high       ← ✗ 無視（コロンなし）
  - due: 2025-01-15     ← ✓ 認識
  - これはメモです       ← ✗ 無視（key: value形式でない）
  - : 値だけ            ← ✗ 無視（keyが空）
```

### エラー処理

- 壊れた行は無視し、パースできた部分だけを使用
- ボード表示をブロックしない

---

## タスクの識別

### タスクID

タスクは「パス + タイトル」の組み合わせで一意に識別する。

```
ID = パス::タイトル
例: "仕事 / プロジェクトA::APIの実装"
```

- IDはMarkdownには保存されない（パース時に都度生成）
- タイトルやパスを変更すると別タスクとして扱われる

### 重複タスクの扱い

同じパスに同じタイトルのタスクが複数ある場合：

1. **パース時**: 警告（Warning）を出力する
   - 例: `⚠ 重複タスクを検出: "APIの実装" (仕事 / プロジェクトA) - 10行目, 25行目`
2. **ボード表示**: 全て表示する（それぞれ別カードとして）
3. **編集時**: 最初に見つかったタスクを更新する

ユーザーは重複を避けることが推奨されるが、警告を無視して操作することも可能。

### 外部編集との競合

エディタ側でMarkdownが編集された場合：

1. ボード操作時に最新のMarkdownを再パースする
2. パス + タイトルでタスクを特定し、変更を適用する
3. 同一タスクへの変更は「ボード操作が優先」（Last Write Wins）

---

## タスクカードの表示

### タスク名

- Markdown形式でレンダリングする（太字、コード、リンク等を反映）
- 長いタスク名は折り返し表示

```markdown
- [ ] `API` の **重要な** 修正 → カード上でMarkdownとして表示
```

### パス

- バッジとして表示

---

## 将来の拡張（MVP対象外）

### 自動検出機能

1. コマンドパレットから `Kanban: Detect columns` で手動実行
2. 設定で `autoDetect: true` の場合、ボード表示時に自動検出（通知で確認）

### フィルタ機能

- パスによる表示/非表示のフィルタリング

### 追加メタデータ対応

- `priority`: 優先度（high / medium / low）
- `due`: 期限
- `assignee`: 担当者
- `tags`: タグ

### 複数ファイル対応

- ワークスペース内の複数Markdownファイルを横断して表示
- ファイルをパスの最上位として扱う

### 挿入位置のカスタマイズ

```jsonc
{
  "markdownKanban.newTaskPosition": "afterHeading:## タスクリスト"
}
```

### 手動並び替え

- 子要素 `order` による順序管理
- または VSCode側での状態保持

---

## 拡張機能情報

| 項目 | 値 |
|------|-----|
| 表示名 | Markdown Kanban |
| ID | markdown-kanban |
| 対象 | VSCode |

---

## 改訂履歴

| 日付 | 内容 |
|------|------|
| 2025-01-XX | 初版作成 |
| 2025-01-XX | タスクの識別（ID生成、重複タスクの扱い、外部編集との競合）を追加 |